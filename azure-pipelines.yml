trigger:
- main

variables:
  acrName: myacrrepo564321
  imageName: indianncpldemo12

  # AKS
  azureSubscription: Terraform_connect
  azureResourceGroup: rg-stage-akscluster
  aksCluster: stage-akscluster
  namespace: default
  k8sManifest: azure-aks.yaml

stages:

# -------------------------------------------------------
# Stage 1: Build & Push Docker Image to ACR
# -------------------------------------------------------
- stage: Build
  displayName: 'Build and Push Docker Image to ACR'
  jobs:
    - job: Build
      displayName: 'Build and Push Docker Image'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - checkout: self

        # Login to Azure and ACR, build & push Docker image
        - task: AzureCLI@2
          displayName: 'Build and Push Docker Image via Azure CLI'
          inputs:
            azureSubscription: Terraform_connect
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              echo "Logging in to ACR..."
              az acr login --name $(acrName)
              
              echo "Building Docker image..."
              docker build -t $(acrName).azurecr.io/$(imageName):latest .
              
              echo "Pushing Docker image to ACR..."
              docker push $(acrName).azurecr.io/$(imageName):latest

# -------------------------------------------------------
# Stage 2: Deploy to AKS
# -------------------------------------------------------
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  jobs:
    - job: Deploy
      displayName: 'Deploy to AKS'
      pool:
        vmImage: 'ubuntu-latest'
      steps:
        - task: KubernetesManifest@1
          displayName: 'Deploy using KubernetesManifest'
          inputs:
            action: deploy
            kubernetesServiceEndpoint: Kubernetes_connectenv
            namespace: $(namespace)
            manifests: |
              $(k8sManifest)

        # Optional fallback using kubectl
        - task: Kubernetes@1
          displayName: 'kubectl apply fallback'
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceEndpoint: Kubernetes_connectenv
            namespace: $(namespace)
            command: apply
            useConfigurationFile: true
            configuration: $(k8sManifest)
