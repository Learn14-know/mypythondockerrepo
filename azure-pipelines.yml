trigger:
- main

variables:
  # Docker
  imageName: saurya123789/indianncpldemo
  dockerConnection: ConnectionDocker

  # AKS
  azureSubscription: AzureConnect
  azureResourceGroup: NCPLindia
  aksCluster: myAKSCluster
  namespace: default
  k8sManifest: azure-aks.yaml


stages:

# ---------------------------
# Stage 1: Build & Push Docker Image
# ---------------------------
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
    - job: Build
      displayName: 'Build and Push an image'
      pool:
        vmImage: 'ubuntu-latest'
      steps:

        - checkout: self

        - task: Docker@0
          displayName: 'Build Docker Image'
          inputs:
            containerregistrytype: 'Container Registry'
            dockerRegistryConnection: $(dockerConnection)
            imageName: $(imageName)
            qualifyImageName: false
            includeLatestTag: true

        - task: Docker@0
          displayName: 'Push Docker Image'
          inputs:
            containerregistrytype: 'Container Registry'
            dockerRegistryConnection: $(dockerConnection)
            action: 'Push an image'
            imageName: $(imageName)
            qualifyImageName: false
            includeLatestTag: true


# ---------------------------
# Stage 2: Deploy to AKS
# ---------------------------
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  jobs:
    - job: Deploy
      pool:
        vmImage: 'ubuntu-latest'
      steps:

        - task: KubernetesManifest@1
          displayName: 'Deploy to AKS'
          inputs:
            connectionType: 'Azure Resource Manager'
            azureSubscriptionConnection: $(azureSubscription)
            azureResourceGroup: $(azureResourceGroup)
            kubernetesCluster: $(aksCluster)
            namespace: $(namespace)
            manifests: $(k8sManifest)

        - task: Kubernetes@1
          displayName: 'kubectl apply (fallback)'
          inputs:
            connectionType: 'Azure Resource Manager'
            azureSubscriptionEndpoint: $(azureSubscription)
            azureResourceGroup: $(azureResourceGroup)
            kubernetesCluster: $(aksCluster)
            namespace: $(namespace)
            command: apply
            useConfigurationFile: true
            configuration: $(k8sManifest)
