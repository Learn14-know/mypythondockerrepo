trigger:
- main

variables:
  # Docker
  imageName: saurya123789/indianncpldemo
  dockerConnection: ConnectionDocker

  # AKS
  azureSubscription: AzureConnect
  azureResourceGroup: NCPLindia
  aksCluster: myAKSCluster
  namespace: default
  k8sManifest: azure-aks.yaml

stages:

# ---------------------------
# Stage 1: Build and Push Docker Image
# ---------------------------
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    displayName: 'Build & Push'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: Checkout@1

      - task: Docker@2
        displayName: 'Build and Push Docker Image'
        inputs:
          command: buildAndPush
          containerRegistry: $(dockerConnection)
          repository: $(imageName)
          Dockerfile: '**/Dockerfile'
          tags: |
            latest

# ---------------------------
# Stage 2: Deploy to AKS
# ---------------------------
- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  jobs:
  - job: Deploy
    displayName: 'Deploy'
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: KubernetesManifest@1
        displayName: 'Deploy to AKS'
        inputs:
          connectionType: 'Azure Resource Manager'
          azureSubscriptionConnection: $(azureSubscription)
          azureResourceGroup: $(azureResourceGroup)
          kubernetesCluster: $(aksCluster)
          namespace: $(namespace)
          manifests: $(k8sManifest)

      # Optional fallback: kubectl apply
      - task: Kubernetes@1
        displayName: 'kubectl apply'
        inputs:
          connectionType: 'Azure Resource Manager'
          azureSubscriptionEndpoint: $(azureSubscription)
          azureResourceGroup: $(azureResourceGroup)
          kubernetesCluster: $(aksCluster)
          namespace: $(namespace)
          command: apply
          useConfigurationFile: true
          configuration: $(k8sManifest)



