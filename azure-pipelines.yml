trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  imageName: saurya123789/indianncpldemo
  dockerConnection: ConnectionDocker
  azureSubscription: AzureConnect
  azureResourceGroup: NCPLindia
  aksCluster: myAKSCluster
  k8sManifest: azure-aks.yaml
  namespace: default

jobs:
- job: BuildAndDeploy
  displayName: Build, Push Docker Image and Deploy to AKS
  steps:

    # Checkout the code
    - task: Checkout@1

    # Build and push Docker image using Docker@2
    - task: Docker@2
      displayName: 'Build and Push Docker Image'
      inputs:
        command: buildAndPush
        containerRegistry: $(dockerConnection)
        repository: $(imageName)
        Dockerfile: '**/Dockerfile'
        tags: |
          latest

    # Deploy using KubernetesManifest@1
    - task: KubernetesManifest@1
      displayName: 'Deploy to AKS'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionConnection: $(azureSubscription)
        azureResourceGroup: $(azureResourceGroup)
        kubernetesCluster: $(aksCluster)
        namespace: $(namespace)
        manifests: $(k8sManifest)

    # Optional: kubectl apply as a fallback (can remove if KubernetesManifest works)
    - task: Kubernetes@1
      displayName: 'kubectl apply'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: $(azureSubscription)
        azureResourceGroup: $(azureResourceGroup)
        kubernetesCluster: $(aksCluster)
        namespace: $(namespace)
        command: apply
        useConfigurationFile: true
        configuration: $(k8sManifest)



